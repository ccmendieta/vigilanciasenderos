<div id="view-admin" class="hidden card-panel white">
  <h5 class="center-align indigo-text">Panel Administrativo</h5>
  <p class="center-align" id="u-nom-admin"></p>
  
  <div class="row">
    <button class="btn btn-main-nav col s12" onclick="loadAdminVisitas()">Visitas Activas</button>
    <button class="btn btn-main-nav col s12" onclick="loadAdminVigilantes()">Gestionar Vigilantes</button>
    <button class="btn btn-main-nav col s12" onclick="loadAdminMudanzas()">Autorizar Mudanzas</button>
    <button class="btn orange col s12" onclick="showView('view-pass')">Cambiar Contraseña</button>
    <button class="btn red col s12" onclick="logout()">Cerrar Sesión</button>
  </div>
</div>

<div id="view-admin-visitas" class="hidden card-panel white">
  <h5>Visitas en Sitio</h5>
  <div id="list-admin-visitas"></div>
  <button class="btn grey" onclick="showView('view-admin')">Volver</button>
</div>

<div id="view-admin-mudanzas" class="hidden card-panel white">
  <h5>Gestión de Mudanzas</h5>
  <button class="btn blue" onclick="formMudanza()">Nueva Autorización</button>
  <div id="list-mudanzas"></div>
  <button class="btn grey" onclick="showView('view-admin')">Volver</button>
</div>

<script>
// --- NUEVAS FUNCIONES ADMIN V17.0 ---

async function loadAdminVisitas() {
  showView('view-admin-visitas');
  const r = await call({action:'buscarVisitasActivas', termino:''});
  const box = document.getElementById('list-admin-visitas');
  box.innerHTML = r.data.length ? "" : "<p>No hay visitas activas.</p>";
  r.data.forEach(v => {
    box.innerHTML += `
      <div class="result-box">
        <p><b>Inmueble:</b> ${v.inm} | <b>Ingresó con:</b> ${v.vigilante}</p>
        <p><b>Visitante:</b> ${v.nom} (${v.placa})</p>
        ${renderTel(v.tel)}
        <button class="btn-small red" onclick="confirmarSalida(${v.fila})">Forzar Salida</button>
      </div>`;
  });
}

async function loadAdminMudanzas() {
  showView('view-admin-mudanzas');
  const r = await call({action:'getAdminData'});
  const box = document.getElementById('list-mudanzas');
  box.innerHTML = "";
  r.mudanzas.forEach(m => {
    box.innerHTML += `
      <div class="result-box">
        <p><b>${m.tipo}:</b> Inm ${m.inm}</p>
        <p><b>Fecha:</b> ${m.fecha} | <b>Resp:</b> ${m.nomP || m.nomA}</p>
        <button class="btn-small red" onclick="eliminarMudanza(${m.id})">Eliminar</button>
      </div>`;
  });
}

async function eliminarMudanza(id) {
  if(confirm("¿Eliminar autorización?")) {
    await call({action:'gestionarMudanza', data: {op:'eliminar', id: id}});
    loadAdminMudanzas();
  }
}

// --- REGLAS DE PLACA V17.0 ---
async function guardarVisita() {
  const tipo = document.getElementById('v-tipo').value;
  const placa = document.getElementById('v-placa').value;
  
  // Validación frontal rápida para obligar placa en vehículos
  if(!['PEATONAL','BICICLETA'].includes(tipo) && !placa) {
    alert("La placa es obligatoria para este tipo de vehículo");
    return;
  }

  const d = { 
    inm: currentInmueble, 
    nom: document.getElementById('v-nom').value, 
    tel: document.getElementById('v-tel').value, 
    tipo: tipo, 
    placa: placa, 
    obs: document.getElementById('v-obs').value 
  };
  
  const r = await call({action:'registrarVisita', data:d});
  if(r.success) { alert("Ingreso Exitoso"); volverMenu(); } 
  else { alert(r.message); }
}
</script>
